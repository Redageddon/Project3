@using API.DataModels.Food
@model PlannersDataModel
@{
    Layout = "_Layout";
    bool isUserLoggedIn = ViewBag.IsUserLoggedIn is bool b && b;
    MealsDataModel? allMeals = ViewBag.AllMeals as MealsDataModel;
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="mb-0">Planner</h2>
            <small class="text-muted">Select an existing planner or create a new one</small>
        </div>
        <a asp-action="CreatePlanner" class="btn btn-primary">Create New Planner</a>
    </div>

    @if (!isUserLoggedIn)
    {
        <div class="alert alert-info">Please log in to view and manage your planners.</div>
    }
    else
    {
        <div class="card p-3">
            <label for="plannerSelect" class="form-label">Your Planners</label>
            <select id="plannerSelect" class="form-select">
                <option value="">-- Select a planner --</option>
                @foreach (PlannerModel p in Model.Planners.OrderByDescending(p => p.PlannedDate))
                {
                    <option value="@p.PlannerId">@p.PlannedDate.ToString("yyyy-MM-dd") (Id: @p.PlannerId)</option>
                }
                <option value="__create__">+ Create New Planner...</option>
            </select>
            <div class="form-text">Choose a planner date or pick the last option to create one.</div>
        </div>

            <div id="plannerDetails" class="mt-3" style="display:none;">
                <div class="card mb-2" id="card-breakfast" style="cursor: pointer;">
                    <div class="card-body py-2"><strong>Breakfast:</strong> <span id="pd-breakfast">—</span></div>
                </div>
                <div class="card mb-2" id="card-lunch" style="cursor: pointer;">
                    <div class="card-body py-2"><strong>Lunch:</strong> <span id="pd-lunch">—</span></div>
                </div>
                <div class="card mb-2" id="card-dinner" style="cursor: pointer;">
                    <div class="card-body py-2"><strong>Dinner:</strong> <span id="pd-dinner">—</span></div>
                </div>
            </div>

            <script>
                (function(){
                    const select = document.getElementById('plannerSelect');
                    const details = document.getElementById('plannerDetails');
                    const elB = document.getElementById('pd-breakfast');
                    const elL = document.getElementById('pd-lunch');
                    const elD = document.getElementById('pd-dinner');
                    
                    const cardB = document.getElementById('card-breakfast');
                    const cardL = document.getElementById('card-lunch');
                    const cardD = document.getElementById('card-dinner');

                    const planners = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                        Model.Planners.Select(p => new { p.PlannerId, p.BreakfastId, p.LunchId, p.DinnerId })
                    ));

                    const mealMap = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                        (allMeals?.Meals ?? new List<MealsModel>())
                            .ToDictionary(m => m.MealId, m => string.IsNullOrWhiteSpace(m.Name) ? ($"Meal #{m.MealId}") : m.Name)
                    ));

                    function mealName(id){
                        if (id == null) return 'None';
                        const key = String(id);
                        return mealMap[key] || `Meal #${id}`;
                    }
                    
                    function setupMealClick(card, mealId) {
                        if (mealId != null) {
                            card.onclick = () => window.location.href = `/Meals/${mealId}`;
                            card.style.cursor = 'pointer';
                        } else {
                            card.onclick = null;
                            card.style.cursor = 'default';
                        }
                    }

                    select?.addEventListener('change', function(){
                        const val = this.value;
                        if (val === '__create__') {
                            window.location.href = '@Url.Action("CreatePlanner", "Planner")';
                            return;
                        }
                        if (!val) {
                            details.style.display = 'none';
                            return;
                        }
                        const pid = parseInt(val, 10);
                        const p = planners.find(x => x.PlannerId === pid);
                        if (!p) {
                            details.style.display = 'none';
                            return;
                        }
                        elB.textContent = mealName(p.BreakfastId);
                        elL.textContent = mealName(p.LunchId);
                        elD.textContent = mealName(p.DinnerId);
                        
                        setupMealClick(cardB, p.BreakfastId);
                        setupMealClick(cardL, p.LunchId);
                        setupMealClick(cardD, p.DinnerId);
                        
                        details.style.display = '';
                    });
                })();
            </script>
    }
</div>
